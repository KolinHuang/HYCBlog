<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>JavaWeb SSM+Maven实现简单的秒杀系统 | 黄玉才的博客</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="JavaWeb SSM+Maven实现简单的秒杀系统" /><meta name="author" content="Kol Huang" /><meta property="og:locale" content="en_US" /><meta name="description" content="参考自：https://github.com/codingXiaxw/seckill" /><meta property="og:description" content="参考自：https://github.com/codingXiaxw/seckill" /><link rel="canonical" href="www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/" /><meta property="og:url" content="www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/" /><meta property="og:site_name" content="黄玉才的博客" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-03T19:44:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="JavaWeb SSM+Maven实现简单的秒杀系统" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Kol Huang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/"},"url":"www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/","author":{"@type":"Person","name":"Kol Huang"},"headline":"JavaWeb SSM+Maven实现简单的秒杀系统","dateModified":"2020-11-03T19:44:00+08:00","description":"参考自：https://github.com/codingXiaxw/seckill","datePublished":"2020-11-03T19:44:00+08:00","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/HYCBlog/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/HYCBlog/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/HYCBlog/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/HYCBlog/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/HYCBlog/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/HYCBlog/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/HYCBlog/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/HYCBlog/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/HYCBlog/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/HYCBlog/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/HYCBlog/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/HYCBlog/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/HYCBlog/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/HYCBlog/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/HYCBlog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/HYCBlog/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/HYCBlog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/HYCBlog/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/HYCBlog/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/HYCBlog/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/HYCBlog/assets/css/post.css"><link rel="stylesheet" href="/HYCBlog/assets/css/post.css"><link rel="preload" as="style" href="/HYCBlog/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/HYCBlog/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176388509-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-176388509-1'); </script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/HYCBlog/assets/js/post.min.js" async></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script src="/HYCBlog/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="http://www.yucaihuang.com" alt="avatar"> <img src="/HYCBlog/assets/img/daliy/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/HYCBlog/">黄玉才的博客</a></div><div class="site-subtitle font-italic">把开源的变成自己的，把自己的变成祖传的!</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/HYCBlog/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/HYCBlog/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/HYCBlog/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/HYCBlog/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/HYCBlog/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/KolinHuang" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['yc_huang97','163.com'].join('@'))" > <i class="fas fa-envelope"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/HYCBlog/"> Posts </a> </span> <span>JavaWeb SSM+Maven实现简单的秒杀系统</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>JavaWeb SSM+Maven实现简单的秒杀系统</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 3, 2020, 7:44 PM +0800" > Nov 3 <i class="unloaded">2020-11-03T19:44:00+08:00</i> </span> by <span class="author"> Kol Huang</div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Nov 4, 2020, 8:42 PM +0800" > Nov 4 <i class="unloaded">2020-11-04T20:42:52+08:00</i> </span></div></div><div class="post-content"><p>参考自：https://github.com/codingXiaxw/seckill</p><h3 id="1-业务流程描述">1. 业务流程描述</h3><p><strong>用户成功秒杀商品，系统需要做的事：</strong></p><p>1、减库存；</p><p>2、记录用户的购买明细。（1.谁购买成功了。2.购买成功的时间/有效期。3.付款/发货信息）</p><p><strong>为什么我们的系统需要事务:</strong></p><p>1.用户成功秒杀商品我们记录了其购买明细却没有减库存，导致超卖。</p><p>2.减了库存却没有记录用户的购买明细，导致少卖。</p><p><strong>如何在保证事务的情况下，实现高并发？</strong></p><h3 id="2环境搭建">2.环境搭建</h3><h4 id="21-添加依赖">2.1 添加依赖</h4><p>单元测试、日志、数据库相关依赖、servlet web相关、mybatis、Spring核心依赖、Spring-dao、spring-web依赖</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
</pre><td class="rouge-code"><pre>		<span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--单元测试--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.13.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--日志--&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.7.30<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>logback-core<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.2.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--实现slf4j接口整合--&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.2.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="c">&lt;!--数据库连接池--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>c3p0<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.9.1.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--数据库驱动--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>8.0.22<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--servlet web相关依赖--&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>taglibs<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>standard<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.1.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.0-alpha-1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet.jsp<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet.jsp-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.3.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jstl<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.11.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="c">&lt;!--SSM框架--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.5.6<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.0.5<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!--spring 依赖--&gt;</span>
        <span class="c">&lt;!--spring核心依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-core<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-beans<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!--spring-dao依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-tx<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!--spring web依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--spring test依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.9.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


    <span class="nt">&lt;/dependencies&gt;</span>
</pre></table></code></div></div><h3 id="3-dao层">3. Dao层</h3><h4 id="31-创建数据库和表">3.1 创建数据库和表</h4><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">create</span> <span class="k">database</span> <span class="n">seckill</span><span class="p">;</span>

<span class="n">use</span> <span class="n">seckill</span><span class="p">;</span>


<span class="k">create</span> <span class="k">table</span> <span class="nv">`seckill`</span><span class="p">(</span>
	<span class="nv">`seckill_id`</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span> <span class="k">comment</span> <span class="s1">'商品库存ID'</span><span class="p">,</span>
	<span class="nv">`name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'商品名称'</span><span class="p">,</span>
	<span class="nv">`number`</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'库存数量'</span><span class="p">,</span>
	<span class="nv">`start_time`</span> <span class="nb">timestamp</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'秒杀开始时间'</span><span class="p">,</span>
	<span class="nv">`end_time`</span> <span class="nb">timestamp</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'秒杀结束时间'</span><span class="p">,</span>
	<span class="nv">`create_time`</span> <span class="nb">timestamp</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="k">current_timestamp</span> <span class="k">comment</span> <span class="s1">'创建时间'</span><span class="p">,</span>
	<span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">seckill_id</span><span class="p">),</span>
	<span class="k">key</span> <span class="n">idx_start_time</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span>
	<span class="k">key</span> <span class="n">idx_end_time</span><span class="p">(</span><span class="n">end_time</span><span class="p">),</span>
	<span class="k">key</span> <span class="n">idx_create_time</span><span class="p">(</span><span class="n">create_time</span><span class="p">)</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="n">auto_increment</span><span class="o">=</span><span class="mi">1000</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span> <span class="k">comment</span><span class="o">=</span><span class="s1">'秒杀库存表'</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">seckill</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">number</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">end_time</span><span class="p">)</span>
<span class="k">values</span>
	<span class="p">(</span><span class="s1">'1000元秒杀iphone12'</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">'2020-10-30 00:00:00'</span><span class="p">,</span><span class="s1">'2020-10-31 00:00:00'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'800元秒杀ipad pro'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">'2020-10-30 00:00:00'</span><span class="p">,</span><span class="s1">'2020-10-31 00:00:00'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'6600元秒杀iMac'</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">'2020-10-30 00:00:00'</span><span class="p">,</span><span class="s1">'2020-10-31 00:00:00'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'7000元秒杀macbook pro'</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">'2020-10-30 00:00:00'</span><span class="p">,</span><span class="s1">'2020-10-31 00:00:00'</span><span class="p">);</span>
	
<span class="c1">--秒杀成功明细表</span>
<span class="c1">--用户登录认证相关信息：简化为手机号</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">success_killed</span><span class="p">(</span>
	<span class="nv">`seckill_id`</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'秒杀商品ID'</span><span class="p">,</span>
	<span class="nv">`user_phone`</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">'用户手机号'</span><span class="p">,</span>
	<span class="nv">`state`</span> <span class="nb">tinyint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="o">-</span><span class="mi">1</span> <span class="k">comment</span> <span class="s1">'状态标识：-1:无效 0:成功 1:已付款 2:已发货'</span><span class="p">,</span>
	<span class="nv">`create_time`</span> <span class="nb">timestamp</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="k">current_timestamp</span> <span class="k">comment</span> <span class="s1">'创建时间'</span><span class="p">,</span>
	<span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="n">seckill_id</span><span class="p">,</span> <span class="n">user_phone</span><span class="p">),</span><span class="cm">/*联合主键？*/</span>
	<span class="k">key</span> <span class="n">idx_create_time</span><span class="p">(</span><span class="n">create_time</span><span class="p">)</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span> <span class="k">comment</span><span class="o">=</span><span class="s1">'秒杀成功明细表'</span><span class="p">;</span>
</pre></table></code></div></div><h4 id="32-创建实体类">3.2 创建实体类</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Seckill</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">start_time</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">create_time</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Seckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckill_id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">number</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">start_time</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">end_time</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">create_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckill_id</span> <span class="o">=</span> <span class="n">seckill_id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="n">number</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end_time</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">create_time</span> <span class="o">=</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Seckill</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Seckill{"</span> <span class="o">+</span>
                <span class="s">"seckill_id="</span> <span class="o">+</span> <span class="n">seckill_id</span> <span class="o">+</span>
                <span class="s">", name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="s">", number="</span> <span class="o">+</span> <span class="n">number</span> <span class="o">+</span>
                <span class="s">", start_time="</span> <span class="o">+</span> <span class="n">start_time</span> <span class="o">+</span>
                <span class="s">", end_time="</span> <span class="o">+</span> <span class="n">end_time</span> <span class="o">+</span>
                <span class="s">", create_time="</span> <span class="o">+</span> <span class="n">create_time</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSeckill_id</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeckill_id</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckill_id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckill_id</span> <span class="o">=</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getStart_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">start_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStart_time</span><span class="o">(</span><span class="nc">Date</span> <span class="n">start_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getEnd_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnd_time</span><span class="o">(</span><span class="nc">Date</span> <span class="n">end_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end_time</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getCreate_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreate_time</span><span class="o">(</span><span class="nc">Date</span> <span class="n">create_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">create_time</span> <span class="o">=</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SuccessKilled</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">user_phone</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">short</span> <span class="n">state</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">create_time</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SuccessKilled</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckill_id</span><span class="o">,</span> <span class="kt">long</span> <span class="n">user_phone</span><span class="o">,</span> <span class="kt">short</span> <span class="n">state</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">create_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckill_id</span> <span class="o">=</span> <span class="n">seckill_id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">user_phone</span> <span class="o">=</span> <span class="n">user_phone</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">create_time</span> <span class="o">=</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">SuccessKilled</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"SuccessKilled{"</span> <span class="o">+</span>
                <span class="s">"seckill_id="</span> <span class="o">+</span> <span class="n">seckill_id</span> <span class="o">+</span>
                <span class="s">", user_phone="</span> <span class="o">+</span> <span class="n">user_phone</span> <span class="o">+</span>
                <span class="s">", state="</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span>
                <span class="s">", create_time="</span> <span class="o">+</span> <span class="n">create_time</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSeckill_id</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeckill_id</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckill_id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckill_id</span> <span class="o">=</span> <span class="n">seckill_id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getUser_phone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">user_phone</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUser_phone</span><span class="o">(</span><span class="kt">long</span> <span class="n">user_phone</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">user_phone</span> <span class="o">=</span> <span class="n">user_phone</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getState</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setState</span><span class="o">(</span><span class="kt">short</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getCreate_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreate_time</span><span class="o">(</span><span class="nc">Date</span> <span class="n">create_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">create_time</span> <span class="o">=</span> <span class="n">create_time</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><h4 id="33-创建dao接口">3.3 创建dao接口</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.yucaihuang.pojo.Seckill</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SeckillMapper</span> <span class="o">{</span>

    <span class="cm">/**
     * 减库存的方法
     * @param seckill_id
     * @param kill_time
     * @return  表示更新库存的记录行数
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceNumber</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">,</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"killTime"</span><span class="o">)</span> <span class="nc">Date</span> <span class="n">kill_time</span><span class="o">);</span>

    <span class="cm">/**
     * 根据id查询秒杀的商品信息
     * @param seckill_id
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">queryById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">);</span>

    <span class="cm">/**
     * 根据偏移量查询秒杀商品列表（什么偏移量？）
     * @param off
     * @param limit
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="nf">queryAll</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.yucaihuang.pojo.SuccessKilled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SuccessKilledMapper</span> <span class="o">{</span>

    <span class="cm">/**
     * 插入购买明细，可过滤重复
     * @param seckill_id
     * @param user_phone
     * @return  插入的行数
     */</span>
    <span class="kt">int</span> <span class="nf">insertSuccessKilled</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">,</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userPhone"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">user_phone</span><span class="o">);</span>

    <span class="nc">SuccessKilled</span> <span class="nf">queryByIdWithSeckill</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">seckill_id</span><span class="o">,</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userPhone"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">user_phone</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><h4 id="34-动态代理实现dao接口">3.4 动态代理实现dao接口</h4><p>mybatis全局配置文件<code class="language-plaintext highlighter-rouge">mybatis-config.xml</code></p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span>

<span class="nt">&lt;configuration&gt;</span>

    <span class="c">&lt;!--配置全局属性--&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!--使用jdbc的getGenerateKeys获取自增主键值--&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"useGenerateKeys"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--使用列别名替换列名
        开启后mybatis会自动帮我们把表中name的值赋到对应的实体的title属性中
        --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"useColumnLabel"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

    <span class="nt">&lt;typeAliases&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"com.yucaihuang.pojo"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeAliases&gt;</span>

    <span class="nt">&lt;mappers&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">class=</span><span class="s">"com.yucaihuang.dao.SeckillMapper"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">class=</span><span class="s">"com.yucaihuang.dao.SuccessKilledMapper"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/mappers&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></table></code></div></div><p>映射配置，必须与接口同名，但是这个Mapper文件存放的位置有两种形式：</p><ul><li><p>XxxMapper.xml和XxxMapper.java接口文件放在同个包下，即都放在<code class="language-plaintext highlighter-rouge">com.yucaihuang.dao</code>下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/Users/huangyucai/Library/Application Support/typora-user-images/image-20201031150351335.png" alt="image-20201031150351335" /></p><p>那么需要在pom.xml下加入以下配置，处理静态资源：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;resources&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory&gt;</span>src/main/java<span class="nt">&lt;/directory&gt;</span>
                <span class="nt">&lt;includes&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.xml<span class="nt">&lt;/include&gt;</span>
                <span class="nt">&lt;/includes&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;/resources&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
</pre></table></code></div></div><p>然后在mybatis-config.xml主配置文件中配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;mappers&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">class=</span><span class="s">"com.yucaihuang.dao.SeckillMapper"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">class=</span><span class="s">"com.yucaihuang.dao.SuccessKilledMapper"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/mappers&gt;</span>
</pre></table></code></div></div><p>或者在后面的spring-dao.xml配置文件中配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--绑定mybatis配置文件，交给Spring管理--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:mybatis-config.xml"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"mapperLocations"</span> <span class="na">value=</span><span class="s">"classpath:Mapper/*.xml"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre></table></code></div></div></li><li><p>或者直接在resources目录下存放XxxMapper.xml文件：</p><p>然后在mybatis-config.xml主配置文件中配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;mappers&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">resource=</span><span class="s">"Mapper/SeckillMapper.xml"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;mapper</span> <span class="na">resource=</span><span class="s">"Mapper/SuccessKilledMapper.xml"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/mappers&gt;</span>
</pre></table></code></div></div><p>或者在后面的spring-dao.xml配置文件中配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--绑定mybatis配置文件，交给Spring管理--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:mybatis-config.xml"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"mapperLocations"</span> <span class="na">value=</span><span class="s">"classpath:Mapper/*.xml"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre></table></code></div></div></li></ul><p><code class="language-plaintext highlighter-rouge">SeckillMapper.xml</code></p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>

<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.yucaihuang.dao.SeckillMapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">"reduceNumber"</span><span class="nt">&gt;</span>
        update seckill.seckill
        set number = number-1
        where seckill_id=#{seckillId}
        and start_time <span class="cp">&lt;![CDATA[ &lt;= ]]&gt;</span> #{killTime}
        and end_time &gt;= #{killTime}
        and number &gt; 0;

    <span class="nt">&lt;/update&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"queryById"</span> <span class="na">resultType=</span><span class="s">"Seckill"</span> <span class="na">parameterType=</span><span class="s">"long"</span><span class="nt">&gt;</span>
        select * from seckill.seckill
        where seckill_id=#{seckillId};
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"queryAll"</span> <span class="na">resultType=</span><span class="s">"Seckill"</span><span class="nt">&gt;</span>
        select * from seckill.seckill
        order by create_time desc
        limit #{offset},#{limit}
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">SuccessKilledMapper.xml</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"UTF-8"</span> <span class="o">?&gt;</span>
<span class="o">&lt;!</span><span class="no">DOCTYPE</span> <span class="n">mapper</span>
        <span class="no">PUBLIC</span> <span class="s">"-//mybatis.org//DTD Config 3.0//EN"</span>
        <span class="s">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">mapper</span> <span class="n">namespace</span><span class="o">=</span><span class="s">"com.yucaihuang.dao.SuccessKilledMapper"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">insert</span> <span class="n">id</span><span class="o">=</span><span class="s">"insertSuccessKilled"</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">"long"</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span><span class="n">当出现主键冲突时</span><span class="err">（</span><span class="n">即重复秒杀时</span><span class="err">），</span><span class="n">会报错</span><span class="err">；</span><span class="n">不想让程序报错</span><span class="err">，</span><span class="n">就加入ignore</span><span class="o">???--&gt;</span>
        <span class="n">insert</span> <span class="n">ignore</span> <span class="n">into</span> <span class="n">seckill</span><span class="o">.</span><span class="na">success_killed</span><span class="o">(</span><span class="n">seckill_id</span><span class="o">,</span> <span class="n">user_phone</span><span class="o">,</span><span class="n">state</span><span class="o">)</span>
        <span class="n">values</span> <span class="o">(</span><span class="err">#</span><span class="o">{</span><span class="n">seckillId</span><span class="o">},</span><span class="err">#</span><span class="o">{</span><span class="n">userPhone</span><span class="o">},</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">&lt;/</span><span class="n">insert</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">select</span> <span class="n">id</span><span class="o">=</span><span class="s">"queryByIdWithSeckill"</span> <span class="n">resultType</span><span class="o">=</span><span class="s">"SuccessKilled"</span><span class="o">&gt;</span>
        <span class="n">select</span>
        <span class="n">sk</span><span class="o">.</span><span class="na">seckill_id</span><span class="o">,</span>
        <span class="n">sk</span><span class="o">.</span><span class="na">user_phone</span><span class="o">,</span>
        <span class="n">sk</span><span class="o">.</span><span class="na">create_time</span><span class="o">,</span>
        <span class="n">sk</span><span class="o">.</span><span class="na">state</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">seckill_id</span> <span class="s">"seckill.seckill_id"</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">name</span> <span class="s">"seckill.name"</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">number</span> <span class="s">"seckill"</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">start_time</span> <span class="s">"seckill.start_time"</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">end_time</span> <span class="s">"seckill.end_time"</span><span class="o">,</span>
        <span class="n">s</span><span class="o">.</span><span class="na">create_time</span> <span class="s">"seckill.create_time"</span>
        <span class="n">from</span> <span class="n">seckill</span><span class="o">.</span><span class="na">success_killed</span> <span class="n">sk</span>
        <span class="n">inner</span> <span class="n">join</span> <span class="n">seckill</span><span class="o">.</span><span class="na">seckill</span> <span class="n">s</span> <span class="n">on</span> <span class="n">sk</span><span class="o">.</span><span class="na">seckill_id</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="na">seckill_id</span>
        <span class="n">where</span> <span class="n">sk</span><span class="o">.</span><span class="na">seckill_id</span><span class="o">=</span><span class="err">#</span><span class="o">{</span><span class="n">seckillId</span><span class="o">}</span>
        <span class="n">and</span> <span class="n">sk</span><span class="o">.</span><span class="na">user_phone</span><span class="o">=</span><span class="err">#</span><span class="o">{</span><span class="n">userPhone</span><span class="o">};</span>
    <span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">mapper</span><span class="o">&gt;</span>
</pre></table></code></div></div><h4 id="35-整合spring和mybatis">3.5 整合spring和mybatis</h4><p>编写<code class="language-plaintext highlighter-rouge">spring-dao.xml</code>，让Spring管理数据库连接池和dao接口的动态注入：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--关联数据库配置文件--&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:jdbc.properties"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="na">id=</span><span class="s">"dataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClass"</span> <span class="na">value=</span><span class="s">"${jdbc.driver}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--c3p0私有属性--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxPoolSize"</span> <span class="na">value=</span><span class="s">"30"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minPoolSize"</span> <span class="na">value=</span><span class="s">"10"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--关闭连接后不自动commit--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoCommitOnClose"</span> <span class="na">value=</span><span class="s">"false"</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!--获取连接超时时间--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"checkoutTimeout"</span> <span class="na">value=</span><span class="s">"1000"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--当获取连接失败重试次数--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"acquireRetryAttempts"</span> <span class="na">value=</span><span class="s">"2"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>



    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--绑定mybatis配置文件，交给Spring管理--&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:mybatis-config.xml"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"typeAliasesPackage"</span> <span class="na">value=</span><span class="s">"com.yucaihuang.pojo"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"mapperLocations"</span> <span class="na">value=</span><span class="s">"classpath:Mapper/*.xml"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--实现dao接口动态注入--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sqlSessionFactoryBeanName"</span> <span class="na">value=</span><span class="s">"sqlSessionFactory"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"basePackage"</span> <span class="na">value=</span><span class="s">"com.yucaihuang.dao"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></table></code></div></div><h4 id="36-dao层测试">3.6 dao层测试</h4><p>测试SeckillMapper.java接口方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="cm">/**
 * junt整合spring
 */</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">//告诉junit spring的配置文件</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">"classpath:spring-dao.xml"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillMapperTest</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">SeckillMapper</span> <span class="n">seckillMapper</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduceNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">reduceNumber</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryById</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">seckillId</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>
        <span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryById</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">seckill</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="n">seckills</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryAll</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">:</span> <span class="n">seckills</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">seckill</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>三个方法均测试通过。</p><p>测试SuccessKilledMapper.java接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">"classpath:spring-dao.xml"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SuccessKilledMapperTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SuccessKilledMapper</span> <span class="n">successKilledMapper</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertSuccessKilled</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">successKilledMapper</span><span class="o">.</span><span class="na">insertSuccessKilled</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span><span class="mi">12855555</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryByIdWithSeckill</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SuccessKilled</span> <span class="n">successKilled</span> <span class="o">=</span> <span class="n">successKilledMapper</span><span class="o">.</span><span class="na">queryByIdWithSeckill</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span> <span class="mi">12855555</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">successKilled</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>两个方法均测试通过。</p><h3 id="4-service层">4. Service层</h3><h4 id="41-创建业务层接口">4.1 创建业务层接口</h4><p>编写业务层接口，有两个重要的方法：1、暴露秒杀接口的地址。2、处理秒杀</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 业务层
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SeckillService</span> <span class="o">{</span>

    <span class="cm">/**
     * 查询全部的秒杀记录
     * @return
     */</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="nf">getSeckillList</span><span class="o">();</span>

    <span class="cm">/**
     * 按ID查询秒杀记录
     * @return
     */</span>
    <span class="nc">Seckill</span> <span class="nf">getSeckillById</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">);</span>

    <span class="c1">//往下是我们最重要的行为的一些接口</span>

    <span class="cm">/**
     * 在秒杀开启时输出秒杀接口的地址，否则输出系统时间和秒杀时间
     * @param seckillId
     * @return
     */</span>
    <span class="nc">Exposer</span> <span class="nf">exportSeckillUrl</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">);</span>

    <span class="cm">/**
     * 执行秒杀操作，有可能失败，有可能成功，所以要抛出我们允许的异常
     * @param seckillId
     * @param userPhone
     * @param md5
     * @return
     * @throws SeckillException
     * @throws RepeatKillException
     * @throws SeckillCloseException
     */</span>
    <span class="nc">SeckillExecution</span> <span class="nf">executeSeckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userPhone</span><span class="o">,</span> <span class="nc">String</span> <span class="n">md5</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SeckillException</span><span class="o">,</span> <span class="nc">RepeatKillException</span><span class="o">,</span> <span class="nc">SeckillCloseException</span><span class="o">;</span>
<span class="o">}</span>

</pre></table></code></div></div><h4 id="42-dto封装类">4.2 dto封装类</h4><p>建立一个包dto，用于封装业务层给web传输的数据，其中包括上面两个重要方法的返回值封装：<code class="language-plaintext highlighter-rouge">Exposer</code>和<code class="language-plaintext highlighter-rouge">SeckillExecution</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 暴露秒杀地址(接口)DTO
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exposer</span> <span class="o">{</span>

    <span class="c1">//是否开启秒杀</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">exposed</span><span class="o">;</span>

    <span class="c1">//对秒杀地址加密的措施</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">md5</span><span class="o">;</span>

    <span class="c1">//id为seckillId的商品的秒杀地址</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">seckillId</span><span class="o">;</span>

    <span class="c1">//系统当前时间（毫秒）</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">now_time</span><span class="o">;</span>

    <span class="c1">//秒杀的开启时间</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">start_time</span><span class="o">;</span>

    <span class="c1">//秒杀的结束时间</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">end_time</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">exposed</span><span class="o">,</span> <span class="nc">String</span> <span class="n">md5</span><span class="o">,</span> <span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exposed</span> <span class="o">=</span> <span class="n">exposed</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">md5</span> <span class="o">=</span> <span class="n">md5</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">exposed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">now_time</span><span class="o">,</span> <span class="kt">long</span> <span class="n">start_time</span><span class="o">,</span> <span class="kt">long</span> <span class="n">end_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exposed</span> <span class="o">=</span> <span class="n">exposed</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">now_time</span> <span class="o">=</span> <span class="n">now_time</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end_time</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">exposed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exposed</span> <span class="o">=</span> <span class="n">exposed</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isExposed</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">exposed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setExposed</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">exposed</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exposed</span> <span class="o">=</span> <span class="n">exposed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getMd5</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">md5</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMd5</span><span class="o">(</span><span class="nc">String</span> <span class="n">md5</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">md5</span> <span class="o">=</span> <span class="n">md5</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSeckillId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeckillId</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getNow_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">now_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNow_time</span><span class="o">(</span><span class="kt">long</span> <span class="n">now_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">now_time</span> <span class="o">=</span> <span class="n">now_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStart_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">start_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStart_time</span><span class="o">(</span><span class="kt">long</span> <span class="n">start_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getEnd_time</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnd_time</span><span class="o">(</span><span class="kt">long</span> <span class="n">end_time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end_time</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 封装执行秒杀后的结果：是否秒杀成功
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillExecution</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">seckillId</span><span class="o">;</span>

    <span class="c1">//秒杀执行结果的状态</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">state</span><span class="o">;</span>

    <span class="c1">//状态的明文标识</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">stateInfo</span><span class="o">;</span>

    <span class="c1">//当秒杀成功时，需要传递秒杀成功的对象回去</span>
    <span class="kd">private</span> <span class="nc">SuccessKilled</span> <span class="n">successKilled</span><span class="o">;</span>

    <span class="cm">/**
     * 秒杀成功返回所有信息
     * @param seckillId
     * @param seckillStatEnum
     * @param stateInfo
     * @param successKilled
     */</span>
    <span class="kd">public</span> <span class="nf">SeckillExecution</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span> <span class="n">seckillStatEnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">stateInfo</span><span class="o">,</span> <span class="nc">SuccessKilled</span> <span class="n">successKilled</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">seckillStatEnum</span><span class="o">.</span><span class="na">getState</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stateInfo</span> <span class="o">=</span> <span class="n">stateInfo</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">successKilled</span> <span class="o">=</span> <span class="n">successKilled</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 秒杀失败
     * @param seckillId
     * @param seckillStatEnum
     * @param stateInfo
     */</span>
    <span class="kd">public</span> <span class="nf">SeckillExecution</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span> <span class="n">seckillStatEnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">stateInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">seckillStatEnum</span><span class="o">.</span><span class="na">getState</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stateInfo</span> <span class="o">=</span> <span class="n">stateInfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSeckillId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeckillId</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillId</span> <span class="o">=</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getState</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setState</span><span class="o">(</span><span class="kt">int</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getStateInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stateInfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStateInfo</span><span class="o">(</span><span class="nc">String</span> <span class="n">stateInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stateInfo</span> <span class="o">=</span> <span class="n">stateInfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">SuccessKilled</span> <span class="nf">getSuccessKilled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">successKilled</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSuccessKilled</span><span class="o">(</span><span class="nc">SuccessKilled</span> <span class="n">successKilled</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">successKilled</span> <span class="o">=</span> <span class="n">successKilled</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="43-异常处理类">4.3 异常处理类</h4><p>创建一个exception包，用于处理异常，主要有两个异常：1、重复秒杀异常；2、秒杀结束异常。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">SeckillException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">SeckillException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.exception</span><span class="o">;</span>

<span class="cm">/**
 * 重复秒杀异常，是一个运行时异常，不需要我们手动try catch
 * mysql只支持运行时异常的回滚操作
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RepeatKillException</span> <span class="kd">extends</span> <span class="nc">SeckillException</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RepeatKillException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">RepeatKillException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.exception</span><span class="o">;</span>


<span class="cm">/**
 * 秒杀关闭异常，当秒杀结束时，用户还要进行秒杀，就会出现这个异常
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillCloseException</span> <span class="kd">extends</span> <span class="nc">SeckillException</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">SeckillCloseException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">SeckillCloseException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="44-业务层接口的实现">4.4 业务层接口的实现</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.yucaihuang.dao.SeckillMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.dao.SuccessKilledMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.dto.Exposer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.dto.SeckillExecution</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.enums.SeckillStatEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.exception.RepeatKillException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.exception.SeckillCloseException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.exception.SeckillException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.pojo.Seckill</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.pojo.SuccessKilled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yucaihuang.service.SeckillService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.DigestUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillServiceImpl</span> <span class="kd">implements</span> <span class="nc">SeckillService</span> <span class="o">{</span>


    <span class="c1">//日志对象</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

    <span class="c1">//加入一个混淆字符串（秒杀接口）的salt，为了避免用户猜出我们的md5值，值任意给，越复杂越好</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">salt</span><span class="o">=</span><span class="s">"safjlvllj`asdl.kn"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">SeckillMapper</span> <span class="n">seckillMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">SuccessKilledMapper</span> <span class="n">successKilledMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeckillMapper</span><span class="o">(</span><span class="nc">SeckillMapper</span> <span class="n">seckillMapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seckillMapper</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSuccessKilledMapper</span><span class="o">(</span><span class="nc">SuccessKilledMapper</span> <span class="n">successKilledMapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">successKilledMapper</span> <span class="o">=</span> <span class="n">successKilledMapper</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="nf">getSeckillList</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryAll</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">4</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">getSeckillById</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryById</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 根据seckillId来验证此产品是否在秒杀商品信息中，如果存在就判断当前时间是否在秒杀时间段内
     * 如果二者都成立，就生成一个加密后的md5，返回
     * @param seckillId
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Exposer</span> <span class="nf">exportSeckillUrl</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryById</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="c1">//说明查不到这个秒杀产品的记录</span>
        <span class="k">if</span><span class="o">(</span><span class="n">seckill</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Date</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">seckill</span><span class="o">.</span><span class="na">getStart_time</span><span class="o">();</span>
        <span class="nc">Date</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">seckill</span><span class="o">.</span><span class="na">getEnd_time</span><span class="o">();</span>
        <span class="nc">Date</span> <span class="n">now_time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
        <span class="c1">//若是当前时间不在秒杀时间段内</span>
        <span class="k">if</span><span class="o">(</span><span class="n">start_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">now_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">||</span> <span class="n">end_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">now_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">()){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">seckillId</span><span class="o">,</span> <span class="n">now_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">(),</span> <span class="n">start_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">(),</span><span class="n">end_time</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">//秒杀开启，返回秒杀商品的id、用给接口加密的md5</span>
        <span class="nc">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">getMD5</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Exposer</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">md5</span><span class="o">,</span> <span class="n">seckillId</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getMD5</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">base</span> <span class="o">=</span> <span class="n">seckillId</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">salt</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="nc">DigestUtils</span><span class="o">.</span><span class="na">md5DigestAsHex</span><span class="o">(</span><span class="n">base</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">md5</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 秒杀是否成功，若成功：减库存，增加明细；失败：抛出异常，mysql自动事务回滚
     * @param seckillId
     * @param userPhone
     * @param md5
     * @return
     * @throws SeckillException
     * @throws RepeatKillException
     * @throws SeckillCloseException
     */</span>
    <span class="kd">public</span> <span class="nc">SeckillExecution</span> <span class="nf">executeSeckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userPhone</span><span class="o">,</span> <span class="nc">String</span> <span class="n">md5</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SeckillException</span><span class="o">,</span> <span class="nc">RepeatKillException</span><span class="o">,</span> <span class="nc">SeckillCloseException</span> <span class="o">{</span>

        <span class="k">if</span><span class="o">(</span><span class="n">md5</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">md5</span><span class="o">.</span><span class="na">equals</span><span class="o">((</span><span class="n">getMD5</span><span class="o">(</span><span class="n">seckillId</span><span class="o">)))){</span>
            <span class="c1">//md5不匹配，说明秒杀数据被重写了，抛出异常</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SeckillException</span><span class="o">(</span><span class="s">"seckill data has been rewrite"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Date</span> <span class="n">now_time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//减库存</span>
            <span class="kt">int</span> <span class="n">updateCount</span> <span class="o">=</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">reduceNumber</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="n">now_time</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">updateCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
                <span class="c1">//没有更新库存记录，说明秒杀结束</span>
                <span class="k">throw</span>  <span class="k">new</span> <span class="nf">SeckillCloseException</span><span class="o">(</span><span class="s">"seckill is closed"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="c1">//成功更新了库存</span>
                <span class="kt">int</span> <span class="n">insertCount</span> <span class="o">=</span> <span class="n">successKilledMapper</span><span class="o">.</span><span class="na">insertSuccessKilled</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="n">userPhone</span><span class="o">);</span>
                <span class="c1">//是否该明细被重复插入，即用户是否重复秒杀</span>
                <span class="k">if</span><span class="o">(</span><span class="n">insertCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RepeatKillException</span><span class="o">(</span><span class="s">"seckill repeated"</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                    <span class="nc">SuccessKilled</span> <span class="n">successKilled</span> <span class="o">=</span> <span class="n">successKilledMapper</span><span class="o">.</span><span class="na">queryByIdWithSeckill</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="n">userPhone</span><span class="o">);</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">SeckillExecution</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">,</span><span class="s">"秒杀成功"</span><span class="o">,</span><span class="n">successKilled</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">SeckillCloseException</span> <span class="n">e1</span><span class="o">){</span>
            <span class="k">throw</span> <span class="n">e1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">RepeatKillException</span> <span class="n">e2</span><span class="o">){</span>
            <span class="k">throw</span> <span class="n">e2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span><span class="n">e</span><span class="o">);</span>
            <span class="c1">//编译期异常转化为运行期异常</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SeckillException</span><span class="o">(</span><span class="s">"seckill inner error :"</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>由于我们返回的数据是交给前端的，所以秒杀是否成功的状态我们封装到一个枚举类中：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.enums</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">enum</span>  <span class="nc">SeckillStatEnum</span> <span class="o">{</span>

    <span class="no">SUCCESS</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"秒杀成功"</span><span class="o">),</span>
    <span class="no">END</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="s">"秒杀结束"</span><span class="o">),</span>
    <span class="no">REPEAT_KILL</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="s">"重复秒杀"</span><span class="o">),</span>
    <span class="no">INNER_ERROR</span><span class="o">(-</span><span class="mi">2</span><span class="o">,</span><span class="s">"系统异常"</span><span class="o">),</span>
    <span class="no">DATE_REWRITE</span><span class="o">(-</span><span class="mi">3</span><span class="o">,</span><span class="s">"数据篡改"</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">state</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">info</span><span class="o">;</span>

    <span class="nc">SeckillStatEnum</span><span class="o">(</span><span class="kt">int</span> <span class="n">state</span><span class="o">,</span> <span class="nc">String</span> <span class="n">info</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getState</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">SeckillStatEnum</span> <span class="nf">stateOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">){</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SeckillStatEnum</span> <span class="n">state</span> <span class="o">:</span> <span class="n">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">getState</span><span class="o">()</span> <span class="o">==</span> <span class="n">index</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="45-将service层交给spring管理">4.5 将Service层交给Spring管理</h4><p>创建<code class="language-plaintext highlighter-rouge">spring-service.xml</code>，配置扫描包，注入service的bean</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span> <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/tx 
        http://www.springframework.org/schema/tx/spring-tx.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.yucaihuang.service"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.yucaihuang.service.impl.SeckillServiceImpl"</span> <span class="na">id=</span><span class="s">"seckillServiceImpl"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"seckillMapper"</span> <span class="na">ref=</span><span class="s">"seckillMapper"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"successKilledMapper"</span> <span class="na">ref=</span><span class="s">"successKilledMapper"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>



    <span class="c">&lt;!--事务--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span> <span class="na">id=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></table></code></div></div><h4 id="46-使用spring的声明式事务配置">4.6 使用Spring的声明式事务配置</h4><p>声明式事务的使用方式:</p><ol><li>早期使用的方式:ProxyFactoryBean+XMl.</li><li>tx:advice+aop命名空间，这种配置的好处就是一次配置永久生效。</li><li>注解@Transactional的方式。</li></ol><p>在实际开发中，建议使用第三种对我们的事务进行控制。继续在<code class="language-plaintext highlighter-rouge">spring-service.xml</code>中配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    <span class="c">&lt;!--配置基于注解的声明式事务--&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>然后在Service实现类方法中，在需要进行事务声明的方法上加上事务的注解：<code class="language-plaintext highlighter-rouge">@Transactional</code></p><p>使用注解控制事务方法的优点：</p><ul><li>开发团队达成一致约定，明确标注事务方法的编程风格；</li><li>保证事务方法的执行时间尽可能短，不要穿插其他网络操作RPC/HTTP请求或者剥离到事务方法外部；</li><li>不是所有的方法都需要事务，如果只有一条修改操作、只读操作不需要事务控制。</li></ul><h4 id="47-service逻辑的集成测试">4.7 Service逻辑的集成测试</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">"classpath:ApplicationContext.xml"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillServiceTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">SeckillService</span> <span class="n">seckillService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getSeckillList</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="n">seckillList</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">getSeckillList</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">:</span> <span class="n">seckillList</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">seckill</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getSeckillById</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Seckill</span> <span class="n">seckillById</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">getSeckillById</span><span class="o">(</span><span class="mi">1001</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">seckillById</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportSeckillUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Exposer</span> <span class="n">exposer</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">exportSeckillUrl</span><span class="o">(</span><span class="mi">1002</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exposer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeSeckill</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SeckillExecution</span> <span class="n">seckillExecution</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">executeSeckill</span><span class="o">(</span><span class="mi">1002</span><span class="o">,</span> <span class="mi">1506779719</span><span class="o">,</span> <span class="s">"80267e7716eeec0135c23d6a4a61add4"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">seckillExecution</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>当重复运行<code class="language-plaintext highlighter-rouge">executeSeckill</code>方法时，出现异常：</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>com.yucaihuang.exception.RepeatKillException: seckill repeated

	at com.yucaihuang.service.impl.SeckillServiceImpl.executeSeckill<span class="o">(</span>SeckillServiceImpl.java:115<span class="o">)</span>
	at sun.reflect.NativeMethodAccessorImpl.invoke0<span class="o">(</span>Native Method<span class="o">)</span>
	at sun.reflect.NativeMethodAccessorImpl.invoke<span class="o">(</span>NativeMethodAccessorImpl.java:62<span class="o">)</span>
com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs<span class="o">(</span>JUnit4IdeaTestRunner.java:68<span class="o">)</span>
	at 
	...
	com.intellij.rt.junit.IdeaTestRunner<span class="nv">$Repeater</span>.startRunnerWithArgs<span class="o">(</span>IdeaTestRunner.java:33<span class="o">)</span>
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart<span class="o">(</span>JUnitStarter.java:230<span class="o">)</span>
	at com.intellij.rt.junit.JUnitStarter.main<span class="o">(</span>JUnitStarter.java:58<span class="o">)</span>

</pre></table></code></div></div><p>这是因为用户进行了重复秒杀，我们应该在该测试方法中添加try catch,将程序允许的异常包起来而不去向上抛给junit。</p><p>由上分析可知，第四个方法只有拿到了第三个方法暴露的秒杀商品的地址后才能进行测试，也就是说只有在第三个方法运行后才能运行测试第四个方法，而实际开发中我们不是这样的，需要将第三个测试方法和第四个方法合并到一个方法从而组成一个完整的逻辑流程:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSeckillSeckillLogic</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="kt">long</span> <span class="n">seckillId</span> <span class="o">=</span> <span class="mi">1002</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">userPhone</span> <span class="o">=</span> <span class="mi">15067729719L</span><span class="o">;</span>
        <span class="nc">Exposer</span> <span class="n">exposer</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">exportSeckillUrl</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">exposer</span><span class="o">.</span><span class="na">isExposed</span><span class="o">()){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exposer</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">exposer</span><span class="o">.</span><span class="na">getMd5</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">seckillService</span><span class="o">.</span><span class="na">executeSeckill</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span><span class="n">userPhone</span><span class="o">,</span><span class="n">md5</span><span class="o">);</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">RepeatKillException</span> <span class="n">e1</span><span class="o">){</span>
                <span class="k">throw</span> <span class="n">e1</span><span class="o">;</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">SeckillCloseException</span> <span class="n">e2</span><span class="o">){</span>
                <span class="k">throw</span> <span class="n">e2</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="c1">//秒杀未开启</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exposer</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><h3 id="5mvc层">5.mvc层</h3><h4 id="51-整合spring">5.1 整合spring</h4><p>创建<code class="language-plaintext highlighter-rouge">spring-mvc.xml</code>配置文件，并开启注解模式、配置静态资源、扫描包、视图解析器</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:mvc=</span><span class="s">"http://www.springframework.org/schema/mvc"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc
        https://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--开启SpringMVC注解模式
    a. 自动注册DefaultAnnotationHanderMapping, AnnotationMethodHandlerAdapter
    b. 默认提供一系列的功能：数据绑定，数字和日期的format @NumberFormat, @DateTimeFormat
    c. xml, json的默认读写支持
    --&gt;</span>
    <span class="nt">&lt;mvc:annotation-driven/&gt;</span>

    <span class="c">&lt;!--静态资源默认servlet配置--&gt;</span>
    <span class="c">&lt;!--
    1. 加入对静态资源的处理：js, gif, png
    2. 允许使用"/"做整体映射
    --&gt;</span>
    <span class="nt">&lt;mvc:default-servlet-handler/&gt;</span>

    <span class="c">&lt;!--扫描Controller--&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.yucaihuang.controller"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!--视图解析器--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"viewClass"</span> <span class="na">value=</span><span class="s">"org.springframework.web.servlet.view.JstlView"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"prefix"</span> <span class="na">value=</span><span class="s">"/WEB-INF/jsp/"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"suffix"</span> <span class="na">value=</span><span class="s">".jsp"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></table></code></div></div><p>写一个Controller先测试一下：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/seckill"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillController</span><span class="o">{</span>
  	<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
  	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">hello</span><span class="o">(){</span>
      	<span class="k">return</span> <span class="s">"hello"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>请求：<code class="language-plaintext highlighter-rouge">localhost:8080/seckill/hello</code>测试成功。</p><h4 id="52-导入静态资源">5.2 导入静态资源</h4><p>将web目录下的文件拷贝到自己的web目录下。</p><h4 id="53-结果封装类">5.3 结果封装类</h4><p>在dto包下创建<code class="language-plaintext highlighter-rouge">SeckillResult.java</code>类，用于封装md5地址和秒杀结果，给前端传值。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.yucaihuang.dto</span><span class="o">;</span>


<span class="cm">/**
 * 将所有的ajax请求返回类型全部封装成json数据
 * @param &lt;T&gt;
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">success</span><span class="o">;</span>
    <span class="kd">private</span> <span class="no">T</span> <span class="n">data</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">error</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SeckillResult</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">success</span><span class="o">,</span> <span class="no">T</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">success</span> <span class="o">=</span> <span class="n">success</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">SeckillResult</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">success</span><span class="o">,</span> <span class="nc">String</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">success</span> <span class="o">=</span> <span class="n">success</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSuccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSuccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">success</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">success</span> <span class="o">=</span> <span class="n">success</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="no">T</span> <span class="nf">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setData</span><span class="o">(</span><span class="no">T</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getError</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">error</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setError</span><span class="o">(</span><span class="nc">String</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><h4 id="54-编写controller方法">5.4 编写Controller方法</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre><td class="rouge-code"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/seckill"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SeckillService</span> <span class="n">seckillService</span><span class="o">;</span>

    <span class="cm">/**
     * 展示秒杀列表
     * @param model
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/list"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">list</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="n">seckillList</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">getSeckillList</span><span class="o">();</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"seckillList"</span><span class="o">,</span><span class="n">seckillList</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"list"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 秒杀商品详情页
     * @param seckillId
     * @param model
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/{seckillId}/detail"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">detail</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">seckillId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">"redirect:/seckill/list"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">getSeckillById</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">seckill</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">"forward:/seckill/list"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"seckill"</span><span class="o">,</span><span class="n">seckill</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">"detail"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回一个JSON数据，数据中封装了我们商品的秒杀地址
     * @param seckillId
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/{seckillId}/exposer"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"application/json;charset=UTF-8"</span><span class="o">})</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Exposer</span><span class="o">&gt;</span> <span class="nf">exposer</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">seckillId</span><span class="o">){</span>
        <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Exposer</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Exposer</span> <span class="n">exposer</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">exportSeckillUrl</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
            <span class="c1">//成功取到了暴露的地址</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Exposer</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span> <span class="n">exposer</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="c1">//取地址失败了，封装异常信息</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Exposer</span><span class="o">&gt;(</span><span class="kc">false</span><span class="o">,</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 用于封装用户是否秒杀成功的信息
     * @param secKillId
     * @param md5
     * @return
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/{seckillId}/{md5}/execution"</span><span class="o">,</span>
    <span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"application/json;charset=UTF-8"</span><span class="o">})</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"seckillId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">secKillId</span><span class="o">,</span>
                                                   <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"md5"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">md5</span><span class="o">,</span>
                                                   <span class="nd">@CookieValue</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"userPhone"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">userPhone</span><span class="o">){</span>

        <span class="k">if</span><span class="o">(</span><span class="n">userPhone</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;(</span><span class="kc">false</span><span class="o">,</span><span class="s">"未注册"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">SeckillExecution</span> <span class="n">execution</span> <span class="o">=</span> <span class="n">seckillService</span><span class="o">.</span><span class="na">executeSeckill</span><span class="o">(</span><span class="n">secKillId</span><span class="o">,</span> <span class="n">userPhone</span><span class="o">,</span> <span class="n">md5</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">execution</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">RepeatKillException</span> <span class="n">e1</span><span class="o">){</span>
            <span class="nc">SeckillExecution</span> <span class="n">execution</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SeckillExecution</span><span class="o">(</span><span class="n">secKillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span><span class="o">.</span><span class="na">REPEAT_KILL</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">execution</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">SeckillCloseException</span> <span class="n">e2</span><span class="o">){</span>
            <span class="nc">SeckillExecution</span> <span class="n">execution</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SeckillExecution</span><span class="o">(</span><span class="n">secKillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span><span class="o">.</span><span class="na">END</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">execution</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="nc">SeckillExecution</span> <span class="n">execution</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SeckillExecution</span><span class="o">(</span><span class="n">secKillId</span><span class="o">,</span> <span class="nc">SeckillStatEnum</span><span class="o">.</span><span class="na">INNER_ERROR</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">SeckillExecution</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">execution</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回系统当前时间
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/time/now"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">time</span><span class="o">(){</span>
        <span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SeckillResult</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span> <span class="n">date</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></table></code></div></div><ul><li><p><code class="language-plaintext highlighter-rouge">@ResponseBody</code>注解表示该方法的返回结果直接写入 HTTP 响应正文中，一般在异步获取数据时使用；</p></li><li>在使用<code class="language-plaintext highlighter-rouge">@RequestMapping</code>后，返回值通常解析为跳转路径，加上<code class="language-plaintext highlighter-rouge">@Responsebody</code>后返回结果不会被解析为跳转路径，而是直接写入HTTP 响应正文中。例如，异步获取<code class="language-plaintext highlighter-rouge">json</code>数据，加上<code class="language-plaintext highlighter-rouge">@Responsebody</code>注解后，就会直接返回<code class="language-plaintext highlighter-rouge">json</code>数据。</li><li><code class="language-plaintext highlighter-rouge">@RequestBody</code>注解则是将 HTTP 请求正文插入方法中，使用适合的<code class="language-plaintext highlighter-rouge">HttpMessageConverter</code>将请求体写入某个对象。</li></ul><h4 id="55-测试">5.5 测试</h4><p>秒杀商品列表：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/KolinHuang/seckill/master/Drawings/seckill_list.png" alt="seckill_list" /></p><p>秒杀商品详情信息：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/KolinHuang/seckill/master/Drawings/seckill_countdown.png" alt="seckill_countdown" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/KolinHuang/seckill/master/Drawings/seckill_start.png" alt="seckill_start" /></p><p>秒杀成功：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/KolinHuang/seckill/master/Drawings/seckill_success.png" alt="seckill_success" /></p><p>重复秒杀：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/KolinHuang/seckill/master/Drawings/seckill_repeat.png" alt="seckill_repeat" /></p><h3 id="6-添加redis缓存">6. 添加Redis缓存</h3><h4 id="61-整合dao层">6.1 整合Dao层</h4><p>在dao包中创建一个RedisMapper.java文件：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisMapper</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nf">RedisMapper</span><span class="o">(</span><span class="nc">String</span> <span class="n">ip</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">){</span>
        <span class="n">jedisPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPool</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span><span class="n">port</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//这是序列化吗</span>
    <span class="kd">private</span> <span class="nc">RuntimeSchema</span><span class="o">&lt;</span><span class="nc">Seckill</span><span class="o">&gt;</span> <span class="n">schema</span> <span class="o">=</span> <span class="nc">RuntimeSchema</span><span class="o">.</span><span class="na">createFrom</span><span class="o">(</span><span class="nc">Seckill</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">getSeckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">){</span>
        <span class="k">return</span> <span class="nf">getSeckill</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 从redis里读数据，如果不存在就返回null
     * @param seckillId
     * @param jedis
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">getSeckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">){</span>
        <span class="kt">boolean</span> <span class="n">hasJedis</span> <span class="o">=</span> <span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">hasJedis</span><span class="o">){</span>
                <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getSeckillRedisKey</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
                <span class="c1">//根据key查询</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                <span class="c1">//如果查到了，说明redis里有这个key的缓存，就反序列化，返回seckill对象</span>
                <span class="k">if</span><span class="o">(</span><span class="n">bytes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="na">newMessage</span><span class="o">();</span>
                    <span class="nc">ProtostuffIOUtil</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="n">seckill</span><span class="o">,</span><span class="n">schema</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">seckill</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">hasJedis</span><span class="o">){</span>
                    <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getSeckillRedisKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">){</span>
        <span class="k">return</span> <span class="s">"seckill:"</span> <span class="o">+</span> <span class="n">seckillId</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 从redis中先读数据，如果没有，就从数据库中读
     * 这个Function挺有意思的，学习一下！
     * @param seckillId
     * @param getDataFromDb
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">getOrPutSeckill</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">,</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Seckill</span><span class="o">&gt;</span> <span class="n">getDataFromDb</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">lockKey</span> <span class="o">=</span> <span class="s">"seckill:locks:getSeckill:"</span><span class="o">+</span><span class="n">seckillId</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">lockRequestId</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//循环争用锁，直到拿到了锁</span>
            <span class="k">for</span><span class="o">(;;){</span>
                <span class="nc">Seckill</span> <span class="n">seckill</span> <span class="o">=</span> <span class="n">getSeckill</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="n">jedis</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">seckill</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="k">return</span> <span class="n">seckill</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">//尝试获取锁</span>
                <span class="kt">boolean</span> <span class="n">getLock</span> <span class="o">=</span> <span class="nc">JedisUtils</span><span class="o">.</span><span class="na">tryGetDistributedLock</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span><span class="n">lockKey</span><span class="o">,</span><span class="n">lockRequestId</span><span class="o">,</span><span class="mi">1000</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">getLock</span><span class="o">){</span>
                    <span class="c1">//获取到了锁,从数据库拿数据，存redis</span>
                    <span class="n">seckill</span> <span class="o">=</span> <span class="n">getDataFromDb</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">seckillId</span><span class="o">);</span>
                    <span class="n">putSeckill</span><span class="o">(</span><span class="n">seckill</span><span class="o">,</span> <span class="n">jedis</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">seckill</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="c1">//无论如何都要把锁释放</span>
            <span class="nc">JedisUtils</span><span class="o">.</span><span class="na">releaseDistributedLock</span><span class="o">(</span><span class="n">jedis</span><span class="o">,</span> <span class="n">lockKey</span><span class="o">,</span> <span class="n">lockRequestId</span><span class="o">);</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">putSeckill</span><span class="o">(</span><span class="nc">Seckill</span> <span class="n">seckill</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">putSeckill</span><span class="o">(</span><span class="n">seckill</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//将Seckill对象序列化后，存入redis</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">putSeckill</span><span class="o">(</span><span class="nc">Seckill</span> <span class="n">seckill</span><span class="o">,</span> <span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">){</span>
        <span class="kt">boolean</span> <span class="n">hasJedis</span> <span class="o">=</span> <span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">hasJedis</span><span class="o">){</span>
                <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getSeckillRedisKey</span><span class="o">(</span><span class="n">seckill</span><span class="o">.</span><span class="na">getSeckill_id</span><span class="o">());</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">ProtostuffIOUtil</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(</span><span class="n">seckill</span><span class="o">,</span> <span class="n">schema</span><span class="o">,</span> <span class="nc">LinkedBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="nc">LinkedBuffer</span><span class="o">.</span><span class="na">DEFAULT_BUFFER_SIZE</span><span class="o">));</span>
                <span class="c1">//超时缓存1小时</span>
                <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">hasJedis</span><span class="o">){</span>
                    <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></table></code></div></div><p>需要用到分布式锁，所以创建一个工具类<code class="language-plaintext highlighter-rouge">JedisUtils</code>，利用<code class="language-plaintext highlighter-rouge">set lock:xx true ex 5 nx</code>原子操作实现锁。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JedisUtils</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LOCK_SUCESS</span> <span class="o">=</span> <span class="s">"OK"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="no">RELEASE_SUCESS</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="cm">/**
     * 尝试获取分布式锁
     * @param jedis
     * @param lockKey
     * @param requestId
     * @param expireTime
     * @return
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">tryGetDistributedLock</span><span class="o">(</span><span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span>
                                                <span class="nc">String</span> <span class="n">requestId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expireTime</span><span class="o">){</span>
        <span class="nc">SetParams</span> <span class="n">setParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetParams</span><span class="o">();</span>
        <span class="n">setParams</span><span class="o">.</span><span class="na">nx</span><span class="o">();</span>
        <span class="n">setParams</span><span class="o">.</span><span class="na">ex</span><span class="o">(</span><span class="n">expireTime</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span><span class="n">requestId</span><span class="o">,</span><span class="n">setParams</span><span class="o">);</span>
        <span class="k">return</span> <span class="no">LOCK_SUCESS</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 释放分布式锁
     * @param jedis
     * @param lockKey
     * @param requestId
     * @return
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">releaseDistributedLock</span><span class="o">(</span><span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="nc">String</span> <span class="n">requestId</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">script</span> <span class="o">=</span> <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span><span class="o">;</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">script</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockKey</span><span class="o">),</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">requestId</span><span class="o">));</span>

        <span class="k">return</span> <span class="no">RELEASE_SUCESS</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></table></code></div></div><p>在<code class="language-plaintext highlighter-rouge">spring-dao.xml</code>中配置bean:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="c">&lt;!--redis--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.yucaihuang.dao.cache.RedisMapper"</span> <span class="na">id=</span><span class="s">"redisMapper"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"118.31.103.27"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"6379"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre></table></code></div></div><h4 id="62-整合service层">6.2 整合Service层</h4><p>注入<code class="language-plaintext highlighter-rouge">redisMapper</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    <span class="kd">private</span> <span class="nc">RedisMapper</span> <span class="n">redisMapper</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRedisMapper</span><span class="o">(</span><span class="nc">RedisMapper</span> <span class="n">redisMapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">redisMapper</span> <span class="o">=</span> <span class="n">redisMapper</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>修改查询逻辑，优先查询Redis：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">getSeckillById</span><span class="o">(</span><span class="kt">long</span> <span class="n">seckillId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">redisMapper</span><span class="o">.</span><span class="na">getOrPutSeckill</span><span class="o">(</span><span class="n">seckillId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Seckill</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="nc">Seckill</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">seckillMapper</span><span class="o">.</span><span class="na">queryById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>更新Service层依赖注入：</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.yucaihuang.service.impl.SeckillServiceImpl"</span> <span class="na">id=</span><span class="s">"seckillServiceImpl"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"seckillMapper"</span> <span class="na">ref=</span><span class="s">"seckillMapper"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"successKilledMapper"</span> <span class="na">ref=</span><span class="s">"successKilledMapper"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"redisMapper"</span> <span class="na">ref=</span><span class="s">"redisMapper"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre></table></code></div></div><p>遇到问题</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Lookup method resolution failed<span class="p">;</span> nested exception is java.lang.IllegalStateE
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Resolution of declared constructors on bean Class <span class="o">[</span>com.yucaihuang.dao.cache.RedisMapper] from ClassLoader <span class="o">[</span>ParallelWebappClassLoader
</pre></table></code></div></div><p>是由于更新了pom.xml之后，没有在lib文件下加入依赖。具体：File -&gt; Project Structure -&gt; Artifacts -&gt; WEB-INF -&gt; lib。</p><p>测试：点击链接后，在redis中查询到了相应的键值。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/HYCBlog/categories/blogging/'>Blogging</a>, <a href='/HYCBlog/categories/javaweb/'>javaweb</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/HYCBlog/tags/web/" class="post-tag no-text-decoration" >web</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=JavaWeb SSM+Maven实现简单的秒杀系统 - 黄玉才的博客&url=www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=JavaWeb SSM+Maven实现简单的秒杀系统 - 黄玉才的博客&u=www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=JavaWeb SSM+Maven实现简单的秒杀系统 - 黄玉才的博客&url=www.yucaihuang.com/HYCBlog/posts/javaweb-seckill/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/HYCBlog/posts/leetcode-solution_hot_100/">Leetcode题解:Hot 100!</a></li><li><a href="/HYCBlog/posts/leetcode-solution_101_200/">Leetcode题解:101~200</a></li><li><a href="/HYCBlog/posts/leetcode-solution_0_100/">Leetcode题解:1~100</a></li><li><a href="/HYCBlog/posts/leetcode-solution_200_500/">Leetcode题解:200~500</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/HYCBlog/tags/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/">算法题解</a> <a class="post-tag" href="/HYCBlog/tags/java%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">Java源码学习</a> <a class="post-tag" href="/HYCBlog/tags/java/">java</a> <a class="post-tag" href="/HYCBlog/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/HYCBlog/tags/web/">web</a> <a class="post-tag" href="/HYCBlog/tags/security/">security</a> <a class="post-tag" href="/HYCBlog/tags/redis/">redis</a> <a class="post-tag" href="/HYCBlog/tags/concurrency/">concurrency</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/HYCBlog/posts/web-javaweb-mybatis_1/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Sep 4 <i class="unloaded">2020-09-04T19:17:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mybatis：环境搭建</h3><div class="text-muted small"><p> 创建maven工程并导入坐标： &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.mybatis&lt;/groupId&gt; &lt;artifactId&gt;mybatis&lt;/artifactId&gt; ...</p></div></div></a></div><div class="card"> <a href="/HYCBlog/posts/web-javaweb-mybatis_2/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Sep 4 <i class="unloaded">2020-09-04T19:18:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mybatis：入门</h3><div class="text-muted small"><p> 入门案例 public class MybatisTest { public static void main(String[] args) throws IOException { //1.读取配置文件 InputStream in = Resources.getResourceAsStream("SqlMapConfig.xml"); ...</p></div></div></a></div><div class="card"> <a href="/HYCBlog/posts/web-javaweb-mybatis_3/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Sep 4 <i class="unloaded">2020-09-04T19:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mybatis：CRUD</h3><div class="text-muted small"><p> 保存操作 在用户Dao接口中定义saveUser抽象方法，用于保存用户： package com.hyc.dao; import com.hyc.domain.User; import org.apache.ibatis.annotations.Select; import java.util.List; /** * 用户的持久层接口 */ public interface I...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/HYCBlog/posts/leetcode-solution_hot_100/" class="btn btn-outline-primary"><p>Leetcode题解:Hot 100!</p></a> <a href="/HYCBlog/posts/java-concurrency-queue/" class="btn btn-outline-primary"><p>Java并发 并发队列原理剖析</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><p class="footer-center"> © 2020 <a href="">Yucai Huang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span> <br> <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备2020032055号-1</a></p></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/HYCBlog/tags/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/">算法题解</a> <a class="post-tag" href="/HYCBlog/tags/java%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">Java源码学习</a> <a class="post-tag" href="/HYCBlog/tags/java/">java</a> <a class="post-tag" href="/HYCBlog/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/HYCBlog/tags/web/">web</a> <a class="post-tag" href="/HYCBlog/tags/security/">security</a> <a class="post-tag" href="/HYCBlog/tags/redis/">redis</a> <a class="post-tag" href="/HYCBlog/tags/concurrency/">concurrency</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-176388509-1', 'auto'); ga('send', 'pageview'); </script> <script> (function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)} ;a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s ;c.parentNode.insertBefore(a,c) })(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js"); galite('create', '{"id"=>"UA-176388509-1", "pv"=>{"enabled"=>false, "proxy_url"=>"", "proxy_endpoint"=>"", "cache"=>true}}', 'auto'); galite('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/HYCBlog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="www.yucaihuang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
